# 以太坊虚拟机

## 总览

以太坊虚拟机或者EVM是以太坊中智能合约的运行时环境。它不仅是沙箱也是一个真实的完整被隔离的环境，这意味着他的代码在EVM内运行时，不会访问网络，文件系统或其他的进程。智能合约甚至可以被限制不能访问其他智能合约。

## 账户

以太坊有两类账户它们共享同一个地址空间：由秘钥对控制的外部账户，由与账户一起存储的代码控制的合约账户。

外部账户的地址由公钥决定，而合约的地址在合约创建时确定。(它源自于创建者的地址和从这个地址发送的交易的数额，也就是所谓的“随机数”)。

无论账户是否存储代码，EVM都会平等的对待这两种类型的地址。

每个账户有一个叫做存储的持久的键值对存放256位字到256位字的映射。

此外，每个账户都有一个以太币余额(准确的说是“Wei”，1个以太币=10^18wei)，可以通过发送包含以太币的交易来修改。

## 交易

一笔交易就是一条消息。它从一个账户发送到另一个账户(它可能是相同的或者空的，见下文)。它可以包含二进制数据（所谓的“有效负载”）和以太币。

如果目标账户包含代码，则执行这段代码并且有效负载像输入数据提供。

如果没有设置目标账户(这笔交易没有收款人，或者收款人被设置成```null```),这笔交易创建一笔新合约。如前所述，这笔合约的地址不是0地址，而是从发送者和这笔交易发送的数额(“随机数”)中派生的地址。这种合约创建交易的有效载荷被视为EVM字节码并被执行。执行的结果(输出数据)作为合约的代码被永久存储。这意味着为了创建合约，你不用发送合约的实际代码，而是发送实际执行时返回该代码的代码。

<div style="background:#76afdb;color:#fff;padding:5px;font-weight:600">
⚠️ Note
</div>
<div style="background:#e9f2fa;color:#404040;padding:10px">
在创建合约时，他的代码还是空的。因此，在构造函数执行完成之前，你不应该在回调正在构造构建的合约。
</div>

<br/>

## Gas （手续费）

创建时，每一笔交易会产生一定数量的gas(手续费)，这笔交易的发起者(```tx.origin```)必须支付这笔费用。 当EVM执行这笔合约的时候，gas会根据特定的规则被逐渐消耗掉。 如果这笔gas在任何时候被用完了，会触发一个out-of-gas的异常，这会终止执行并退回对当前调用帧中状态所做的修改。


这种机制激励了EVM执行时间的经济使用，并且还补偿了EVM执行者(矿工/质押者)工作的报酬。由于每个块都有个最大的gas数量，这个数量也限制了验证块所需的工作数量。

gas的单价是一个被交易发起人设置的值，他必须预先向EVM执行者支付gas单价*gas数量的费用。如果执行后还剩下一下gas，它将被退回给交易的发起人。如果发生恢复更改的异常，用完的gas不会被退回。

由于EVM执行者可以选择是否包含一笔交易，所以交易的发起人不能通过设置一个低gas单价来滥用系统。


### 存储、内存和堆栈

以太坊虚拟机有3个可以存储数据的区域：存储、内存和堆栈。

每个账户有一个被称为存储的数据区域，它在函数调用和交易之间是持久的。存储是一个256位字到256位字映射的键值对。无法从一个和合约中枚举存储，读取成本相对较高，初始化存储和修改存储的成本更高。由于这些成本，你应该让你保存在持久化存储最小化为合约所需要执行的内容。在合约之外存储衍生计算、缓存和聚合等数据。一个可约可以既不读也不写除自己之外的任何存储。

第二个数据区域叫内存，合约每次调用消息，都会获得一个新清除的实例。内存是线性的，它可以在字节级别上寻址，但读取宽度限制为256，而写入可以是8~256位宽。当访问(读或写)一个之前不存在的内存字时，内存会扩展一个256位的字。扩展的时候，必须支付gas费用。内存增长的越大，成本越高。（他是指数级增长的）。

EVM不是寄存器机，却是一个在堆栈机，因此，所有所有计算都在称为堆栈的数据区上执行。它有最大大小为1024个元素，包含256位的字。通过以下方式访问堆栈仅限于顶端：可以将最顶部的16个元素之一复制到堆栈顶部，或者将最顶部的元素与他下面的16个元素之一交换。其他所有的操作都从堆栈中取出最顶部的两个(或者一个，或者更多，取决于操作)元素，并把结果压入堆栈顶部。当然，可以把堆栈元素移动到存储或内存中以便访问堆栈的更深处，但在没有移除堆栈顶部元素的时候，不可能仅访问更深处的元素。

